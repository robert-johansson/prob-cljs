<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>prob-cljs</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; max-width: 860px; margin: 0 auto; padding: 20px; color: #1a1a1a; }
    h1 a { color: inherit; text-decoration: none; }
    .subtitle { color: #666; font-size: 1.1em; margin-top: -8px; }
    .description { color: #444; line-height: 1.5; }
    pre { background: #f0f0f0; padding: 12px; border-radius: 4px; font-size: 13px; overflow-x: auto; }
    #output { background: #1e1e2e; color: #cdd6f4; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 13px; min-height: 100px; white-space: pre-wrap; }
    .btn { background: #3b82f6; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 8px 0; }
    .btn:hover { background: #2563eb; }
    .btn:disabled { background: #94a3b8; cursor: not-allowed; }
    footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e5e5; color: #888; font-size: 13px; text-align: center; }
    footer a { color: #3b82f6; }

    /* Section styling */
    section { margin: 32px 0; }
    section h2 { font-size: 1.3em; margin-bottom: 12px; }

    /* Card grid */
    .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 600px) { .card-grid { grid-template-columns: 1fr; } }
    .card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; text-decoration: none; color: inherit; display: block; transition: border-color 0.15s, box-shadow 0.15s; }
    a.card:hover { border-color: #3b82f6; box-shadow: 0 2px 8px rgba(59,130,246,0.1); }
    .card h3 { margin: 0 0 6px 0; font-size: 1.05em; }
    .card h3 a { color: #3b82f6; text-decoration: none; }
    .card h3 a:hover { text-decoration: underline; }
    .card p { margin: 0; color: #555; font-size: 0.9em; line-height: 1.4; }
    .card .badge { display: inline-block; font-size: 0.7em; padding: 2px 8px; border-radius: 10px; margin-left: 8px; vertical-align: middle; font-weight: normal; }
    .badge-live { background: #dcfce7; color: #166534; }
    .badge-soon { background: #f0f0f0; color: #888; }
    .card.card-muted { border-style: dashed; border-color: #d0d0d0; }
    .card.card-muted h3 { color: #999; }
  </style>
</head>
<body>
  <h1><a href="https://github.com/robert-johansson/prob-cljs">prob-cljs</a></h1>
  <p class="subtitle">Probabilistic programming as a ClojureScript library</p>
  <p class="description">Write probabilistic models as native ClojureScript. Runs in the browser via <a href="https://github.com/babashka/scittle">Scittle</a> and on Node via <a href="https://github.com/babashka/nbb">nbb</a>. Zero external dependencies.</p>

  <section>
    <h2>Interactive Textbooks</h2>
    <div class="card-grid">
      <a class="card" href="probmods/index.html">
        <h3>Probabilistic Models of Cognition <span class="badge badge-live">12 chapters</span></h3>
        <p>Port of <em>v1.probmods.org</em> by Goodman &amp; Tenenbaum. All examples are editable and runnable in the browser.</p>
      </a>
      <div class="card card-muted">
        <h3>Modeling Agents <span class="badge badge-soon">coming soon</span></h3>
        <p>Port of <em>agentmodels.org</em> by Evans, Stuhlm&uuml;ller, Salvatier &amp; Filan. MDPs, POMDPs, and multi-agent models.</p>
      </div>
    </div>
  </section>

  <section>
    <h2>Documentation</h2>
    <div class="card-grid">
      <div class="card card-muted">
        <h3>API Reference <span class="badge badge-soon">coming soon</span></h3>
        <p>Distributions, inference algorithms, and utility functions.</p>
      </div>
    </div>
  </section>

  <section>
    <h2>Try It</h2>
    <p>A live demo running inference directly in your browser:</p>
    <button class="btn" id="run-btn" disabled>Loading...</button>
    <div id="output"></div>
  </section>

  <footer>
    <a href="https://github.com/robert-johansson/prob-cljs">GitHub</a>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/scittle@0.7.28/dist/scittle.js" crossorigin="anonymous"></script>

  <script type="application/x-scittle" src="prob/math.cljs"></script>
  <script type="application/x-scittle" src="prob/erp.cljs"></script>
  <script type="application/x-scittle" src="prob/dist.cljs"></script>
  <script type="application/x-scittle" src="prob/cps_transform.cljc"></script>
  <script type="application/x-scittle" src="prob/cps.cljs"></script>
  <script type="application/x-scittle" src="prob/inference.cljs"></script>
  <script type="application/x-scittle" src="prob/builtins.cljs"></script>
  <script type="application/x-scittle" src="prob/core.cljs"></script>

  <script type="application/x-scittle">
  (ns prob.macros)

  (defmacro rejection-query [& body]
    `(prob.core/rejection-query-fn (fn [] ~@body)))

  (defmacro mh-query [n lag & body]
    `(prob.core/mh-query-fn ~n ~lag (fn [] ~@body)))

  (defmacro enumeration-query [& body]
    `(prob.core/enumeration-query-fn (fn [] ~@body)))
  </script>

  <!-- Demo -->
  <script type="application/x-scittle">
  (require '[prob.core :refer [flip gaussian beta uniform uniform-draw
                                random-integer multinomial sample-discrete
                                gamma dirichlet exponential
                                binomial poisson categorical
                                condition factor observe mem mean variance
                                rejection-query-fn mh-query-fn
                                enumeration-query-fn
                                sample* observe* dist? enumerate* sum prod]])
  (require '[prob.macros :refer [rejection-query mh-query enumeration-query]])

  (def out (js/document.getElementById "output"))
  (def btn (js/document.getElementById "run-btn"))

  (defn log [& args]
    (set! (.-textContent out)
          (str (.-textContent out) (apply str args) "\n")))

  (defn run-demo []
    (set! (.-textContent out) "")
    (set! (.-disabled btn) true)
    (set! (.-textContent btn) "Running...")
    (js/setTimeout
      (fn []
        (try
          (log "=== Rejection Query ===")
          (log "Conditioned flip: "
            (rejection-query (let [x (flip)] (condition x) x)))

          (log "\n=== Bias Estimation (MH, 500 samples) ===")
          (let [data [true true true false true true false true true true]
                samples (mh-query 500 1
                          (let [bias (beta 1 1)]
                            (doseq [obs data]
                              (condition (= obs (flip bias))))
                            bias))]
            (log "Observations: " data)
            (log "Estimated bias: " (.toFixed (mean samples) 3) " (expected ~0.8)"))

          (log "\n=== Enumeration Query ===")
          (let [[values probs] (enumeration-query
                                 (let [a (flip) b (flip)]
                                   (condition (or a b))
                                   (list a b)))]
            (log "P(a,b | a or b):")
            (doseq [[v p] (map vector values probs)]
              (log "  " v " -> " (.toFixed p 3))))

          (log "\n=== Memoized Random Function ===")
          (let [eye-color (mem (fn [person]
                                 (uniform-draw ["blue" "brown" "green"])))]
            (log "Alice: " (eye-color "alice"))
            (log "Alice (same!): " (eye-color "alice"))
            (log "Bob: " (eye-color "bob")))

          (log "\n=== Fair Coin (1000 samples) ===")
          (let [samples (mh-query 1000 1 (if (flip) 1 0))]
            (log "Mean: " (.toFixed (mean samples) 3) " (expected ~0.5)")
            (log "Variance: " (.toFixed (variance samples) 3) " (expected ~0.25)"))

          (log "\nDone!")
          (catch :default e
            (log "\nError: " (.-message e))))
        (set! (.-disabled btn) false)
        (set! (.-textContent btn) "Run again"))
      50))

  (set! (.-disabled btn) false)
  (set! (.-textContent btn) "Run inference")
  (set! (.-onclick btn) run-demo)
  (js/console.log "demo ready")
  </script>
</body>
</html>
