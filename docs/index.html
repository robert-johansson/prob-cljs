<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>prob-cljs</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; max-width: 860px; margin: 0 auto; padding: 20px; }
    h1 a { color: inherit; text-decoration: none; }
    .subtitle { color: #666; }
    pre { background: #f0f0f0; padding: 12px; border-radius: 4px; font-size: 13px; overflow-x: auto; }
    #output { background: #1e1e2e; color: #cdd6f4; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 13px; min-height: 100px; white-space: pre-wrap; }
    .btn { background: #3b82f6; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 8px 0; }
    .btn:hover { background: #2563eb; }
    .btn:disabled { background: #94a3b8; cursor: not-allowed; }
    footer { margin-top: 40px; color: #888; font-size: 13px; text-align: center; }
    footer a { color: #3b82f6; }
  </style>
</head>
<body>
  <h1><a href="https://github.com/robert-johansson/prob-cljs">prob-cljs</a></h1>
  <p class="subtitle">Probabilistic programming as a ClojureScript library</p>
  <p>Running inference directly in your browser via <a href="https://github.com/babashka/scittle">Scittle</a>.</p>

  <button class="btn" id="run-btn" disabled>Loading...</button>
  <div id="output"></div>

  <footer>
    <a href="https://github.com/robert-johansson/prob-cljs">GitHub</a>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/scittle@0.7.28/dist/scittle.js" crossorigin="anonymous"></script>

  <script type="application/x-scittle" src="prob/math.cljs"></script>
  <script type="application/x-scittle" src="prob/erp.cljs"></script>
  <script type="application/x-scittle" src="prob/dist.cljs"></script>
  <script type="application/x-scittle" src="prob/cps_transform.cljc"></script>
  <script type="application/x-scittle" src="prob/cps.cljs"></script>
  <script type="application/x-scittle" src="prob/inference.cljs"></script>
  <script type="application/x-scittle" src="prob/builtins.cljs"></script>
  <script type="application/x-scittle" src="prob/core.cljs"></script>

  <script type="application/x-scittle">
  (ns prob.macros)

  (defmacro rejection-query [& body]
    `(prob.core/rejection-query-fn (fn [] ~@body)))

  (defmacro mh-query [n lag & body]
    `(prob.core/mh-query-fn ~n ~lag (fn [] ~@body)))

  (defmacro enumeration-query [& body]
    `(prob.core/enumeration-query-fn (fn [] ~@body)))
  </script>

  <!-- Demo -->
  <script type="application/x-scittle">
  (require '[prob.core :refer [flip gaussian beta uniform uniform-draw
                                random-integer multinomial sample-discrete
                                gamma dirichlet exponential
                                binomial poisson categorical
                                condition factor observe mem mean variance
                                rejection-query-fn mh-query-fn
                                enumeration-query-fn
                                sample* observe* dist? enumerate* sum prod]])
  (require '[prob.macros :refer [rejection-query mh-query enumeration-query]])

  (def out (js/document.getElementById "output"))
  (def btn (js/document.getElementById "run-btn"))

  (defn log [& args]
    (set! (.-textContent out)
          (str (.-textContent out) (apply str args) "\n")))

  (defn run-demo []
    (set! (.-textContent out) "")
    (set! (.-disabled btn) true)
    (set! (.-textContent btn) "Running...")
    (js/setTimeout
      (fn []
        (try
          (log "=== Rejection Query ===")
          (log "Conditioned flip: "
            (rejection-query (let [x (flip)] (condition x) x)))

          (log "\n=== Bias Estimation (MH, 500 samples) ===")
          (let [data [true true true false true true false true true true]
                samples (mh-query 500 1
                          (let [bias (beta 1 1)]
                            (doseq [obs data]
                              (condition (= obs (flip bias))))
                            bias))]
            (log "Observations: " data)
            (log "Estimated bias: " (.toFixed (mean samples) 3) " (expected ~0.8)"))

          (log "\n=== Enumeration Query ===")
          (let [[values probs] (enumeration-query
                                 (let [a (flip) b (flip)]
                                   (condition (or a b))
                                   (list a b)))]
            (log "P(a,b | a or b):")
            (doseq [[v p] (map vector values probs)]
              (log "  " v " -> " (.toFixed p 3))))

          (log "\n=== Memoized Random Function ===")
          (let [eye-color (mem (fn [person]
                                 (uniform-draw ["blue" "brown" "green"])))]
            (log "Alice: " (eye-color "alice"))
            (log "Alice (same!): " (eye-color "alice"))
            (log "Bob: " (eye-color "bob")))

          (log "\n=== Fair Coin (1000 samples) ===")
          (let [samples (mh-query 1000 1 (if (flip) 1 0))]
            (log "Mean: " (.toFixed (mean samples) 3) " (expected ~0.5)")
            (log "Variance: " (.toFixed (variance samples) 3) " (expected ~0.25)"))

          (log "\nDone!")
          (catch :default e
            (log "\nError: " (.-message e))))
        (set! (.-disabled btn) false)
        (set! (.-textContent btn) "Run again"))
      50))

  (set! (.-disabled btn) false)
  (set! (.-textContent btn) "Run inference")
  (set! (.-onclick btn) run-demo)
  (js/console.log "demo ready")
  </script>
</body>
</html>
