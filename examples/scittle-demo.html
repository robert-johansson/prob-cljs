<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>prob-cljs: Probabilistic Programming in the Browser</title>
  <style>
    body { font-family: monospace; max-width: 800px; margin: 40px auto; padding: 0 20px; line-height: 1.6; }
    h1 { font-size: 1.4em; }
    pre { background: #f4f4f4; padding: 16px; overflow-x: auto; }
    #output { white-space: pre-wrap; background: #1a1a2e; color: #e0e0e0; padding: 20px; min-height: 200px; }
    .section { margin: 20px 0; padding: 10px 0; border-top: 1px solid #ddd; }
  </style>
</head>
<body>
  <h1>prob-cljs: Probabilistic Programming in the Browser</h1>
  <p>This page runs probabilistic inference directly in your browser via
     <a href="https://github.com/babashka/scittle">Scittle</a>.</p>

  <div id="output">Loading...</div>

  <!-- Scittle base -->
  <script src="https://cdn.jsdelivr.net/npm/scittle@0.6.17/dist/scittle.js"></script>

  <!-- prob-cljs plugin (after building: scittle/public/js/scittle.prob.js) -->
  <!-- For development, uncomment and point to your local build: -->
  <!-- <script src="../scittle/public/js/scittle.prob.js"></script> -->

  <!--
    NOTE: Until the plugin JS is built, this demo won't run.
    Build it with:
      cd scittle && npm install && npm run build

    Then serve this file and uncomment the script tag above.

    Alternatively, you can paste the prob namespace registrations
    inline â€” see the README for details.
  -->

  <script type="application/x-scittle">
  (require '[prob.core :refer [flip gaussian beta uniform uniform-draw
                                condition factor mem mean variance
                                rejection-query-fn mh-query-fn]])
  (require '[prob.macros :refer [rejection-query mh-query enumeration-query]])

  (def out (js/document.getElementById "output"))

  (defn log [& args]
    (set! (.-textContent out)
          (str (.-textContent out) (apply str args) "\n")))

  (set! (.-textContent out) "")

  ;; --- 1. Basic coin flip with condition ---
  (log "=== Rejection Query ===")
  (log "Conditioned flip: "
    (rejection-query (let [x (flip)] (condition x) x)))

  ;; --- 2. Estimate bias from data ---
  (log "\n=== Bias Estimation ===")
  (let [data [true true true false true true false true true true]
        samples (mh-query 500 1
                  (let [bias (beta 1 1)]
                    (doseq [obs data]
                      (condition (= obs (flip bias))))
                    bias))]
    (log "Observations: " data)
    (log "Estimated bias: " (.toFixed (mean samples) 3) " (expected ~0.8)"))

  ;; --- 3. Enumeration ---
  (log "\n=== Enumeration Query ===")
  (let [[values probs] (enumeration-query
                         (let [a (flip) b (flip)]
                           (condition (or a b))
                           (list a b)))]
    (log "P(a,b | a or b):")
    (doseq [[v p] (map vector values probs)]
      (log "  " v " -> " (.toFixed p 3))))

  ;; --- 4. Memoized stochastic function ---
  (log "\n=== Memoized Random Function ===")
  (let [eye-color (mem (fn [person]
                         (uniform-draw ["blue" "brown" "green"])))]
    (log "Alice: " (eye-color "alice"))
    (log "Alice again: " (eye-color "alice"))
    (log "Bob: " (eye-color "bob")))

  ;; --- 5. Fair coin mean ---
  (log "\n=== Fair Coin Mean ===")
  (let [samples (mh-query 1000 1 (if (flip) 1 0))]
    (log "Mean of 1000 fair flips: " (.toFixed (mean samples) 3)
         " (expected ~0.5)"))

  (log "\nDone!")
  </script>
</body>
</html>
